{{ define "main" }}
<div class="grid">
    <!-- LEFT: Contributors + Tags -->
    <aside class="left panel" aria-label="filters">
        <div class="hd">collective</div>
        <div class="bd">
            <div id="contributors" class="chips" aria-label="Contributors"></div>
        </div>

        <div class="hd" id="tags">tags</div>
        <div class="bd">
            <div id="facet-tags" class="facet" aria-label="Tag filters"></div>
        </div>
    </aside>

    <!-- CENTER: Query + Histogram + Events -->
    <section class="center panel" aria-label="posts">
        <div class="toolbar">
            <div class="qwrap" style="grid-column:1 / 2">
                <span class="prompt">ircc@siem:$</span>
                <input id="q" placeholder='title:"lsass" tag:memory author:grepStrength' aria-label="Query" />
            </div>
            <select id="range" class="select" title="Time range" aria-label="Time range">
                <option value="7">Last 7d</option>
                <option value="30">Last 30d</option>
                <option value="90">Last 90d</option>
                <option value="all" selected>All</option>
            </select>
            <button id="reset" class="btn">Reset</button>
        </div>

        <div class="hist" id="hist" aria-label="Post frequency"></div>
        <div class="hist-legend">
            <div id="countLabel">0 posts</div>
            <div id="dateLabel"></div>
        </div>

        <div class="bd" id="posts">
            <div
                style="max-height:520px; border:1px solid var(--edge); border-radius:10px; overflow-y:auto; overflow-x:hidden">
                <table class="events" aria-label="Post events">
                    <colgroup>
                        <col id="col-time">
                        <col id="col-authors">
                        <col id="col-title">
                        <col id="col-tags">
                    </colgroup>


                    <thead>
                        <tr>
                            <th data-col="time">TIME <span class="resizer" data-target="col-time"
                                    title="Drag to resize"></span></th>
                            <th data-col="authors">AUTHOR(S) <span class="resizer" data-target="col-authors"
                                    title="Drag to resize"></span>
                            </th>
                            <th data-col="title">TITLE</th> <!-- keep title flexible; no resizer -->
                            <th data-col="tags">TAGS <span class="resizer" data-target="col-tags"
                                    title="Drag to resize"></span></th>
                        </tr>
                    </thead>

                    <tbody id="rows"></tbody>
                </table>

            </div>
    </section>

    <!-- RIGHT: Details -->
    <aside class="right panel" aria-label="details">
        <div class="hd">details</div>
        <div class="bd details" id="details">
            <p style="color:var(--muted)">Select a row to preview a post.</p>
        </div>
    </aside>
</div>

{{- /* Collect pages from the posts section */ -}}
{{- $pages := where site.RegularPages "Section" "posts" -}}
{{- if eq (len $pages) 0 -}}
{{- with site.GetPage "section" "posts" -}}
{{- $pages = .RegularPages -}}
{{- end -}}
{{- end -}}

{{- $allAuthors := slice -}}
{{- $posts := slice -}}

{{- range $pg := $pages -}}
{{- /* stable id */ -}}
{{- $id := "" -}}
{{- with $pg.File -}}{{- $id = .UniqueID -}}{{- else -}}{{- $id = md5 $pg.RelPermalink -}}{{- end -}}

{{- /* authors array */ -}}
{{- $authors := slice -}}
{{- with $pg.Params.authors -}}
{{- $authors = . -}}
{{- else -}}
{{- with $pg.Params.author -}}{{- $authors = (slice .) -}}{{- end -}}
{{- end -}}
{{- $allAuthors = $allAuthors | append $authors -}}

{{- /* description: prefer front matter .Params.description, then .Description, then .Summary */ -}}
{{- $desc := "" -}}
{{- with $pg.Params.description -}}
{{- $desc = . -}}
{{- else -}}
{{- with $pg.Description -}}
{{- $desc = . -}}
{{- else -}}
{{- $desc = $pg.Summary -}}
{{- end -}}
{{- end -}}
{{- /* make it single-line & safe for JSON/JS */ -}}
{{- $desc = $desc | plainify | replaceRE `\s+` " " -}}

{{- /* build the JS object */ -}}
{{- $post := dict
"id" $id
"time" ($pg.Date.Format "2006-01-02T15:04:05Z07:00")
"title" $pg.Title
"authors" $authors
"tags" ($pg.Params.tags | default (slice))
"description" $desc
"type" (cond (isset $pg.Params "external") "external" "internal")
"link" (cond (isset $pg.Params "external") $pg.Params.external $pg.RelPermalink)
-}}
{{- $posts = $posts | append $post -}}
{{- end -}}

{{- $contributors := $allAuthors | uniq | sort -}}
<script>
    window.POSTS = {{ $posts | jsonify | safeJS }};
    window.CONTRIBUTORS = {{ $contributors | jsonify | safeJS }};
</script>



{{- $js := resources.Get "js/app.js" | resources.Minify | resources.Fingerprint -}}
<script defer src="{{ $js.RelPermalink }}" integrity="{{ $js.Data.Integrity }}"></script>

{{ end }}